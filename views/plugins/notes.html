<script src="keymaster.js"></script>


<script>

/*

Notes

*/

//var socket = io.connect();

var note = $('<p/>').attr('id','note')
$('#content').append(note)

var notes_state = $('<img/>').attr('src',"capicon/svg/353.svg")  // icon for play_list on/off
notes_state.attr('id','notes_state')
           .attr('val','false')
           .css({
                'position':'fixed',
                'top':'100px',
                'right':'20px',
                'width':'15px'
              })
$('#content').append(notes_state) // 266, 353, 354

$('#notes_state').click(function(){

      $('#id_view_image').hide()       // prevent the browser to open the svg..
      $('#id_view_image_body').hide()   //

      //-------

      toggle_note()

})

note_activated = false
note_hidden = false

function toggle_note(){

        /*

        toggle_note()

        */

        //alert('toggle_note')


        if (note_activated){      // was activated..
              //alert('deactivate note')
              $('#note').hide()
              note_hidden = true
              //note_hidden = !note_hidden
              note_activated = false

              $('#notes_state').attr('src',"capicon/svg/353.svg") // white


        }else{
              //$('#notes_state').attr('src',"capicon/svg/353.svg") // white
              //alert('activate note !!!')
              socket.emit('ask_notes','')
              socket.on('all_notes', function(txt){
                 var notes = JSON.parse(txt)

                 $.each(notes, function(key, value) {
                       detect_note(key, value)
                 });
                 active_template(notes)
                 note_activated = true
                 note_hidden = false  // ready for hover..
                 //$('#note').show()
                 $('#notes_state').attr('src',"capicon/svg/354.svg") // black
                 //$('#notes_state').attr('src',"capicon/svg/353.svg")

              })
        }


}

function date_full(){

      /*

      Build the text full date
      Return year, month, day, hour, minute, sec

      */

      var date = new Date()
      var sec = date.getSeconds();
      var minute = date.getMinutes();
      var hour = date.getHours();
      var day = date.getDate();
      var month = date.getMonth()+1;
      var year = date.getFullYear();
      var txt_date = [year, month, day, hour, minute, sec].join('_').slice(2)

      return ' ' + txt_date

}

var currelem

function fill_note(elem, id, postop){

      /*

      Dynamically build textarea and button..

      */

      var butt_close = $('<input/>').attr({   // close button
               type: "button",
               id: "close_note",
               value: "x",
               class: "btn btn-success",
               style: "padding: 1px 6px;"
           });
      butt_close.css({"position":"absolute", "top":"8px","right":"10px"})

      var butt_reduce = $('<img/>').attr({
                src: "capicon/svg/353.svg",
                id: "reduce_note",
                class: "btn btn-warning",
                style: "padding: 1px 1px;",
                width: "25px"
              })  // icon for play_list on/off
      butt_reduce.css({"position":"absolute", "top":"-2px","left":"6px"})

      var butt_save = $('<input/>').attr({   // save button
               type: "button",
               id: "save_note",
               value: "save",
               class: "btn btn-warning"
           });
      var textarea = $('<textarea id="text_note" rows="5" cols="43" style=" width: 306px; height: 108px;" /> ')
      var title = $('<h1/>').addClass('note_title')
      title.css({'font-size':'12px', 'box-shadow': '0 0px 0px'})
      elem.append(title) // .css({'font-size':'20px'})
          .append(textarea)
          .append(butt_save)
          .append(butt_reduce)
          .append(butt_close)
      $('#text_note').show()
      butt_save.click(function(){            // send note to server..
          var posdate = ' !id ' + id +  date_full()
          var txt = $('#text_note').val() + posdate
          socket.emit('save_note', txt)
          $('#note').hide()
      })
      butt_reduce.click(function(){            // reduce the window
          $('#text_note').toggle()
          if($("#text_note").is(":visible")){
                $('#note').css({'height':'250px'})
                $('#note').css({'width':'350px'})
                butt_save.show()
                butt_close.show()
                title.show()
            } else{
                $('#note').css({'height':'40px'}) // reduced size height
                $('#note').css({'width':'5px'})  // reduced size width
                butt_save.hide()
                butt_close.hide()
                title.hide()
            }
      })
      butt_close.click(function(){
          toggle_note()
     })
    butt_reduce.click() // present the note in reduced form

}

function note_in_strap(elem, id, postop){

      /*

      Note template

      */

      posnote = postop.toString() + 'px' // note position

      elem.css({'background-color':'rgb(255,224,102)',
                'padding-left': '20px',
                'padding-right': '20px',
                'padding-bottom': '20px',
                'padding-top': '10px',
                'margin-right': '20px',
                'margin-left': '20px',
                'box-shadow': '0.5em 0.5em 0.7em',
                'position': 'absolute',
                'left': '100px',
                //'left': '50px',
                'top': posnote,
                'width': '350px',
                'height': '250px',
                'max-height': '300px',
                //'font-size': '85%',
                'z-index': '3',
                'color': 'black'
                })
      elem.draggable()
      elem.empty()
      fill_note(elem, id, postop)

}

function show_note(id, postop){

      /*

      */

      note_in_strap($('#note'), id, postop)

}

var new_note = false;
socket.on('create_new_note', function(){      // create new note by voice command..

      /*

      Voice commands :
        * ajouter une note, nouvelle note ..

      */

      //alert('in note.html !!!')

      var elem = $(':hover').last()
      id = create_id(elem)
      var postop = Math.round(elem.offset().top,1)  || 0;
      show_note(id, postop)

})

function create_id(elem){

      /*


      */



      // var id;
      // var lformats = ['href', 'data', 'src']
      // lformats.forEach(function(frmt){
      //      if (elem[0].hasAttribute(frmt)){id = elem.attr('href')}
      // })



      if (elem.attr('href')){
          var id = elem.attr('href')
      }
      else if (elem.attr('data')){
          var id = elem.attr('data')
      }
      else if (elem.attr('src')){
          var id = elem.attr('src')
      }
      if (elem.parent().hasClass('youtube')){
          var id = elem.parent().attr('id')
      }

      alert('id')

    return id
}

function deal_with_note(key, value, elem, action){

      /*

      Underline and icon..

      */

      elem.css({"text-decoration" : action})               // underlining
      var icon_note = $('<img/>').attr('src',"capicon/svg/353.svg")  // icon
                                 .addClass('icon_note')
                                 .css({'width':'15px'})
                                 .hide()
      icon_note.click(false);  // deactivate click on icon..
      if (! elem[0].hasAttribute('note')){

          elem.attr('note','true')
          // elem.next().append($('<span/>').text(' ').append(icon_note))

      }

      if (!note_hidden){
         $('#note').show()
         //elem.next().find('.icon_note').show() // show icon for note
         //elem.find('.icon_note').show() // case tog
      }
      else{
         $('#note').hide()
      }
      $('#note').offset({'top' : elem.offset().top})
      $('.note_title').text('Note : ' + value.split('!date')[1])
      $('#text_note').val(value.split('!date')[0])
      //alert(value.split('!date')[0])
      bind_save_butt(key)
      currelem = elem

}

function handle_note(key, value, elem){

      /*


      */

      elem.hover(function(){
          //alert('hover is ok')
          //alert('note_hidden is ' + note_hidden)
          if (currelem != elem){
              //alert("new note")
              try{
                 currelem.css({"text-decoration":'none'}) // remove underlline
                 $('.icon_note').hide() // icon when not on the element..
              }catch(err){} // alert('first elem')

          }
          //note_hidden = false
          deal_with_note(key, value, elem, "underline")
      })

}

function bind_save_butt(key){

      /*

      */

      $('#save_note').unbind()
      $('#save_note').click(function(){
            var posdate = ' !id ' + key + date_full() // Math.round(,1)
            var txt = $('#text_note').val() + posdate
            //alert(txt)
            socket.emit('save_note', txt)
            $('#note').hide()
      })
}

function detect_note(key, value){

      /*

      */

      $('.embed_pdf').each(function(){
        var txt = $(this).text()
        try{
            //var keysplit = key.trim().split('/')[1].split(' ')[0].trim()
            var keysplit = key.trim().split('/')[1].split('#zoom=')[0].trim().split('.pdf?')[0]
            if (keysplit != ''){
                if (txt.search(keysplit) != -1){
                  handle_note( key, value, $(this) )
                  }
             }
          }catch(err){}

      }) // embed.each

      $('a').each(function(){
        var txt = $(this).attr('href')
        if (txt){
          if (txt.search(key) != -1){
                handle_note( key, value, $(this) )
             } // end hover..
          } // if txt
      }) // each href

      $('object').each(function(){
          var type = $(this).attr('type')
          //alert(type)
          if (type == 'application/pdf'){
             //alert('founddddd')
             var txt = $(this).attr('data')
             //alert(txt)
             if (txt.search(key) != -1){
                   //alert(txt)
                   // alert(key)
                   // alert(value)
                   handle_note( key, value, $(this).parent() )
                } // end hover..
          } // if type is application/pdf
      }) // each object

      $('.youtube').each(function(){     // note for straptoc youtube..
        var txt = $(this).attr('id')
        if (txt){
          if (txt.search(key) != -1){
                handle_note( key, value, $(this) )
             } // end hover..
          } // if txt
      }) //

} // detect_note

key('alt+n',function(){

      /*

      Create a new note

      */

      var elem = $(':hover').last()
      id = create_id(elem)
      var postop = Math.round(elem.offset().top,1)  || 0;
      show_note(id, postop)

})

function active_template(notes){

      /*


      */

      var elem = $(':hover').last()
      var first_key = Object.keys(notes)[0]
      var id = first_key
      var postop = Math.round(elem.offset().top,1)  || 0;
      show_note(id, postop)
      $('#note').hide()

}




</script>
