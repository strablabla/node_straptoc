<script  src="util_panel.js"></script>

<script>

/*

Agenda

*/

selected_year = '20'
//selected_month = 4

function date_day(){

      /*

      Build the text date

      */

      var date = new Date()
      var day = date.getDate();
      var month = date.getMonth() + 1;
      var year = date.getFullYear();
      var txt_date = [year, month, day].join('_').slice(2)

      return txt_date

}

//-- Agenda panel

var addr_icon_agenda = "capicon/svg/033.svg"
var icon_agenda = $('<img/>').attr('src',addr_icon_agenda)  // icon for agenda panel
icon_agenda.attr('id','icon_agenda')
           .css({
                'position':'absolute',
                'top':'10px',
                'margin-right':'50%',
                'right':'-8px',
                'width':'17px'
              })
// icon_agenda.click(function(){
//     $('#agenda_state').click()
// })

var agenda_panel = $('<div/>').attr('id','agenda_panel')
$('#content').append(agenda_panel)

var ap_width = 600;
agenda_panel.css({
          'background-color': '#ffffff', //
          'box-shadow': '0.5em 0.5em 2.7em',
          'padding-bottom': '90px',
          'padding-top': '30px',
          'padding-left': '50px',
          'padding-right': '50px',
          'position': 'fixed',
          'right': '-' + ap_width + 'px',   // hidden
          'top': '130px',
          'width': '600px',
          'height': '450px',
          'z-index': '3'
          })
var tit = $('<h3/>').css({'text-align':'center'})
                    .text('Agenda')

// ---- Add elements to agenda panel..

$('#agenda_panel').append(icon_agenda)    // pict Agenda
                  .append(tit)           // title

var agenda_state = $('<img/>').attr('src',addr_icon_agenda)  // icon for agenda toggle
agenda_state.attr('id','agenda_state')
           .attr('val','false')
           .css({
                'position':'fixed',
                'top':'200px',
                'right':'20px',
                'width':'17px'
              })
$('#content').append(agenda_state) //

//---------------------------- year

var dic_css_year_title = {
            'position':'absolute',
            'background-color': 'rgb(255, 238, 204)', //
            //'box-shadow': '0.1em 0.1em 0.7em',
            'padding-bottom': '3px',
            'padding-top': '3px',
            'padding-left': '5px',
            'padding-right': '5px',
            'left': '250px',   // hidden
            'top': '370px',
            'width': '100px',
            'height': '30px',
            'z-index': '4',
            'text-align' : 'center',
            'font-size':'20px',
            'font-family': "apple_garamond",
            'opacity':'0.6'

        }

//---------------------------- Month

var dic_css_month_title = {
            'position':'absolute',
            'background-color': 'rgb(255, 238, 204)', //
            //'box-shadow': '0.1em 0.1em 0.7em',
            'padding-bottom': '3px',
            'padding-top': '3px',
            'padding-left': '5px',
            'padding-right': '5px',
            'left': '250px',   // hidden
            'top': '100px',
            'width': '100px',
            'height': '30px',
            'z-index': '4',
            'text-align' : 'center',
            'font-size':'20px',
            'font-family': "apple_garamond"
        }

//--------- Panel day

agenda_note_css =  {
    'border': '1px solid #000',
    'width': '200px',
    'height': '100px'
}

var css_agenda_note_name  = {
            'position':'absolute',
            'background-color': 'white', //
            //'box-shadow': '0.1em 0.1em 0.7em',
            'padding-bottom': '3px',
            'padding-top': '3px',
            'padding-left': '5px',
            'padding-right': '5px',
            //'left': '50%',   // hidden
            'margin-left': '50px',
            //'top': '10px',
            'width': '200px',
            'height': '30px',
            'z-index': '5',
            'text-align' : 'center',
            'font-size':'18px',
            'font-family': 'apple_garamond'
        }

var final_note_size = 15
var css_agenda_note  = {
            'position':'absolute',
            'background-color': 'white', //
            //'box-shadow': '0.1em 0.1em 0.2em',
            'padding-bottom': '2px',
            'padding-top': '3px',
            'padding-left': '10px',
            'padding-right': '10px',
            //'left': '50%',   // hidden
            'margin-left': '20px',
            //'top': '10px',
            'width': '250px',
            'height': '30px',
            'z-index': '5',
            'text-align' : 'left',
            'font-size': final_note_size + 'px',
            'font-family': 'apple_garamond'
        }

var icon_close_pan_day = $('<img/>').attr('src',"capicon/svg/057.svg")  // icon to close day panel
icon_close_pan_day.attr('id','icon_close_pan_day')
                  .css({
                        'background-color':'white',
                        'position':'absolute',
                        'top':'-1px',
                        // 'margin-right':'50%',
                        'right':'4px',
                        'width':'12px',
                        'height':'12px'
                      })

var dic_css_pan_day_title = {
            'position':'absolute',
            'background-color': 'rgb(255, 238, 204)', //
            //'box-shadow': '0.1em 0.1em 0.7em',
            'padding-bottom': '3px',
            'padding-top': '6px',
            'padding-left': '5px',
            'padding-right': '5px',
            'left': '50%',   // hidden
            'margin-left': '-15px',
            'top': '10px',
            'width': '30px',
            'height': '30px',
            'z-index': '5',
            'text-align' : 'center',
            'font-size':'17px',
            'font-family': 'apple_garamond'
        }

var dic_css_panel_day = {
            'background-color':'white',
            'box-shadow': '0.1em 0.1em 0.7em',
            'position':'fixed',
            'left': '50%',   // hidden
            'top': '70px',
            'width': '900px',
            'margin-left':'-450px',
            'height': '380px',
            'text-align' : 'center',
            'font-size': '20px',
            'font-family': "apple_garamond",
            'z-index': '4'
        }

var dic_css_cell_day = {
            'position': 'absolute',
            'background-color': 'rgb(255, 238, 204)', //
            //'box-shadow': '0.5em 0.5em 2.7em',
            'padding-bottom': '3px',
            'padding-top': '3px',
            'padding-left': '5px',
            'padding-right': '5px',
            'left': '10px',   // hidden
            'top': '10px',
            'width': '10px',
            'height': '10px',
            'z-index': '4',
            'font-size':'15px',
            'text-align' : 'center',
            'font-family': "apple_garamond"
        }

var dic_days = {}
var step_cell_h = 70
var step_cell_v = 40
var size_cell = 25

// ----- offsets

var offset_left = 10
var offset_top = 120  // cells top offset
var dic_months = {
                'Janvier':31,'Février':29, 'Mars':31,'Avril':30, 'Mai':31,
                'Juin':30, 'Juillet':31, 'Août':31, 'Septembre':30, 'Octobre':31,
                'Novembre':30, 'Décembre':31
              }

//--------

dic_css_cell_day['width'] = size_cell
dic_css_cell_day['height'] = size_cell

//----

function calc_index_cell(i,j){

  return (j-1)*7+i

}

function fill_cell(i,j){

      /*



      */

      var index_cell = calc_index_cell(i,j)
      var curr_cell = dic_days[index_cell]
      curr_cell = $('<div/>').css(dic_css_cell_day)
      curr_cell.css({
                      'top': j*step_cell_v + offset_top + 'px',
                      'left': i*step_cell_h + offset_left + 'px'
                    })
      curr_cell.text(index_cell)
      curr_cell.attr('id', 'cell_' + index_cell)

      if ( index_cell == curr_day ){
          //curr_cell.css({ 'box-shadow': '0.2em 0.2em 0.7em' })
          if ((curr_month == selected_month) & (curr_year == selected_year)){
               curr_cell.css({ 'box-shadow': '0.2em 0.2em 0.7em' })
          }

      }
      curr_cell.click(function(){
          $('#pan_day').show()
          $('#pan_day_title').text(index_cell)

          socket.emit('ask_agenda','')
          socket.on('all_agenda', function(text){
              make_notes_areas(text, index_cell)
              note_interact()
          })
      })
      return curr_cell

}

var curr_date = date_day()
curr_year = curr_date.split('_')[0]                   // year
curr_month = parseInt(curr_date.split('_')[1])        // month
curr_day = curr_date.split('_')[2]                    // day

//-------  Panel Agenda

selected_month = curr_month         // beginning with current month..
lmonths = Object.keys(dic_months)
var month_title = $('<div/>').text(lmonths[selected_month - 1]).css(dic_css_month_title)  // dic_months[curr_month]
$('#agenda_panel').append(month_title)
var year_title = $('<div/>').text( '20' + selected_year).css(dic_css_year_title)
$('#agenda_panel').append(year_title)

//----- Panel day

var pan_day_title = $('<div/>').attr('id','pan_day_title')
                               .css(dic_css_pan_day_title) // text('eraeaea').
var pan_day = $('<div/>').attr('id','pan_day')
                         .css(dic_css_panel_day)
                         .append(pan_day_title)
                         .append(icon_close_pan_day)
                         .hide()
function close_and_save_day(){

      $('#pan_day').toggle()
      var dic_day_infos = {}
      var num_day = $('#pan_day_title').text()    // selected day
      dic_day_infos[num_day] = {}
      var dic_curr_day =  dic_day_infos[num_day]
      $('.agenda_note').each(function(){

              var txt = $(this).text()
              var hour = txt.match(/\d{1,2}h\d{0,2}/)
              if (hour != undefined) {
                         dic_curr_day[hour] = txt.split(hour)[1]
                    }
            })

      var str_year_month_day = selected_year + '_' + selected_month + '_' + num_day + '_'
      var infos_agenda_sent = str_year_month_day + JSON.stringify(dic_day_infos[num_day])
      socket.emit('save_agenda', infos_agenda_sent);

}
icon_close_pan_day.click(function(){
      close_and_save_day()
})

function make_notes_areas(text, index_cell){

      var dic_agenda = JSON.parse(text)                 // dict with complete information..
      try{ var infos_day = dic_agenda[selected_year][selected_month][index_cell] }
      catch{ infos_day = undefined }

      step_h = 30 //
      step_mom_day = 300 //
      top_mom = 70

      // The 3 periods

      var morning = $('<div/>').text('Matin')
      morning.css(css_agenda_note_name)
      morning.css({'top': top_mom + 'px', 'left': '-70px'})
      $('#pan_day').append(morning)
      //-------------
      var afternoon = $('<div/>').text('Après-midi')
      afternoon.css(css_agenda_note_name)
      afternoon.css({'top': top_mom + 'px', 'left': '250px'})
       //------------
      $('#pan_day').append(afternoon)
      var evening = $('<div/>').text('Soir')
      evening.css(css_agenda_note_name)
      evening.css({'top': top_mom + 'px', 'right': '120px'})
      //------------
      $('#pan_day').append(evening)

      for (j = 0; j < 3; j++){                // morning, afternoon, evening..
            for (i = 0; i < 6; i++){          // hours

                numh = 6*j + 8 + i          // number hour..
                if (numh < 23){

                      var pos_top = (i+1)*step_h + 100
                      var pos_left = j*step_mom_day + 30
                      var note = $('<div/>').addClass('agenda_note')
                                            .css(css_agenda_note)
                      if (infos_day == undefined){
                            note.text( numh + 'h ... ')  // by default
                          }
                      else{
                          note.text( numh + 'h' + infos_day[numh + 'h'] )  // from dic
                      }
                      note.css({'top': pos_top + 'px', 'left' : pos_left + 'px'})  // note element for hour "numh"
                      $('#pan_day').append(note)
                }

            }
        }
}

var hour_note_size = 14
function note_interact(){             // text <---> input

        $('div.agenda_note').click(function(){
          if(!$(this).children("input").length) {
              $(this).html(function(){
                    return "<input id=txtnote value='" + $(this).html() +  "'style='width: 230px; height: 23px;'>"
              });
              $('#txtnote').css({'font-size': hour_note_size + 'px'})
              $('#txtnote').show()
              $(this).children("input").focus();
          }
        });

        $('div.agenda_note').focusout(null,function(){
             //alert('ouuuutt')
              $(this).html(function(){
                 return $(this).children('input').val();
          });
        });

}

$('#content').append(pan_day) // .text('aeaekahehaohea')

//---------------------- Make day cells for a month..

for (i=1; i < 8; i++){

    for (j=1; j < 6; j++){

      if ( calc_index_cell(i,j) < dic_months[lmonths[selected_month-1]] +1 ){ //
            curr_cell = fill_cell(i,j)
            $('#agenda_panel').append(curr_cell)    // adding a day cell..

          }
    }
}

//----------------------------

toggle_panel('agenda')

</script>
